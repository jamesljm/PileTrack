// ─── PileTrack Prisma Schema ─────────────────────────────────────────────────

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ──────────────────────────────────────────────────────────────────

enum UserRole {
  WORKER
  SUPERVISOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SiteStatus {
  ACTIVE
  INACTIVE
  COMPLETED
}

enum ActivityType {
  BORED_PILING
  MICROPILING
  DIAPHRAGM_WALL
  SHEET_PILING
  PILECAP
  PILE_HEAD_HACKING
  SOIL_NAILING
  GROUND_ANCHOR
  CAISSON_PILE
}

enum ActivityStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum EquipmentStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  DECOMMISSIONED
}

enum ServiceType {
  ROUTINE_MAINTENANCE
  REPAIR
  INSPECTION
  OVERHAUL
  CALIBRATION
  BREAKDOWN_REPAIR
}

enum EquipmentCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  CRITICAL
}

enum EquipmentCategory {
  PILING_RIG
  CRANE
  EXCAVATOR
  CONCRETE_PUMP
  GENERATOR
  COMPRESSOR
  WELDING_MACHINE
  SURVEYING
  SAFETY
  GENERAL
}

enum TransferStatus {
  REQUESTED
  APPROVED
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum SyncAction {
  CREATE
  UPDATE
  DELETE
}

enum HoldPointType {
  PRE_BORING
  PRE_CAGE
  PRE_CONCRETE
}

enum HoldPointStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  ACTIVITY_SUBMITTED
  ACTIVITY_APPROVED
  ACTIVITY_REJECTED
  TRANSFER_REQUESTED
  TRANSFER_APPROVED
  TRANSFER_DELIVERED
  EQUIPMENT_SERVICE_DUE
  LOW_STOCK_ALERT
  SYSTEM
}

enum DailyLogStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum TestType {
  PIT
  STATIC_LOAD_TEST
  DYNAMIC_LOAD_TEST
  CUBE_TEST
  CORE_TEST
  KODEN
  CROSSHOLE_SONIC
}

enum TestResultStatus {
  PENDING
  PASS
  FAIL
  INCONCLUSIVE
}

// ─── Models ─────────────────────────────────────────────────────────────────

model User {
  id             String     @id @default(uuid()) @db.Uuid
  email          String     @unique @db.VarChar(255)
  passwordHash   String     @map("password_hash") @db.VarChar(255)
  firstName      String     @map("first_name") @db.VarChar(100)
  lastName       String     @map("last_name") @db.VarChar(100)
  phone          String?    @db.VarChar(20)
  role           UserRole   @default(WORKER)
  status         UserStatus @default(ACTIVE)
  avatarUrl      String?    @map("avatar_url") @db.VarChar(500)
  lastLoginAt    DateTime?  @map("last_login_at")
  resetToken     String?    @map("reset_token") @db.VarChar(255)
  resetTokenExp  DateTime?  @map("reset_token_exp")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  deletedAt      DateTime?  @map("deleted_at")

  // Relations
  siteUsers      SiteUser[]
  activities     ActivityRecord[] @relation("ActivityCreator")
  approvals      ActivityRecord[] @relation("ActivityApprover")
  transfersFrom  Transfer[]       @relation("TransferRequester")
  transfersAppr  Transfer[]       @relation("TransferApprover")
  refreshTokens  RefreshToken[]
  auditLogs      AuditLog[]
  notifications  Notification[]
  syncLogs       SyncLog[]
  holdPointSigs  HoldPoint[]      @relation("HoldPointSigner")
  serviceRecords ServiceRecord[]  @relation("ServiceRecordCreator")
  dailyLogsCreated   DailyLog[]   @relation("DailyLogCreator")
  dailyLogsApproved  DailyLog[]   @relation("DailyLogApprover")
  boreholeLogsCreated BoreholeLog[] @relation("BoreholeLogCreator")
  testResultsCreated TestResult[]  @relation("TestResultCreator")

  @@index([email])
  @@index([role])
  @@index([status])
  @@index([deletedAt])
  @@map("users")
}

model Site {
  id              String     @id @default(uuid()) @db.Uuid
  name            String     @db.VarChar(200)
  code            String     @unique @db.VarChar(50)
  address         String     @db.VarChar(500)
  clientName      String     @map("client_name") @db.VarChar(200)
  contractNumber  String?    @map("contract_number") @db.VarChar(100)
  gpsLat          Float?     @map("gps_lat")
  gpsLng          Float?     @map("gps_lng")
  status          SiteStatus @default(ACTIVE)
  startDate       DateTime?  @map("start_date")
  expectedEndDate DateTime?  @map("expected_end_date")
  description     String?    @db.Text
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  deletedAt       DateTime?  @map("deleted_at")

  // Relations
  siteUsers       SiteUser[]
  activities      ActivityRecord[]
  equipment       Equipment[]
  materials       Material[]
  transfersFrom   Transfer[] @relation("TransferFromSite")
  transfersTo     Transfer[] @relation("TransferToSite")
  equipmentSiteHistory EquipmentSiteHistory[]
  dailyLogs       DailyLog[]
  boreholeLogs    BoreholeLog[]
  testResults     TestResult[]

  @@index([code])
  @@index([status])
  @@index([deletedAt])
  @@map("sites")
}

model SiteUser {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  siteId    String   @map("site_id") @db.Uuid
  siteRole  String?  @map("site_role") @db.VarChar(50)
  assignedAt DateTime @default(now()) @map("assigned_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([userId, siteId])
  @@index([userId])
  @@index([siteId])
  @@map("site_users")
}

model ActivityRecord {
  id             String         @id @default(uuid()) @db.Uuid
  siteId         String         @map("site_id") @db.Uuid
  activityType   ActivityType   @map("activity_type")
  status         ActivityStatus @default(DRAFT)
  activityDate   DateTime       @map("activity_date") @db.Date
  weather        Json?
  details        Json           @default("{}")
  remarks        String?        @db.Text
  photos         Json?          @default("[]")
  createdById    String         @map("created_by_id") @db.Uuid
  approvedById   String?        @map("approved_by_id") @db.Uuid
  approvedAt     DateTime?      @map("approved_at")
  rejectionNotes String?        @map("rejection_notes") @db.Text
  clientId       String?        @map("client_id") @db.VarChar(100)
  version        Int            @default(1)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  deletedAt      DateTime?      @map("deleted_at")

  // Relations
  site        Site @relation(fields: [siteId], references: [id], onDelete: Cascade)
  createdBy   User @relation("ActivityCreator", fields: [createdById], references: [id])
  approvedBy  User? @relation("ActivityApprover", fields: [approvedById], references: [id])
  holdPoints  HoldPoint[]
  testResults TestResult[]

  @@index([siteId])
  @@index([activityType])
  @@index([status])
  @@index([activityDate])
  @@index([createdById])
  @@index([clientId])
  @@index([deletedAt])
  @@map("activity_records")
}

model Equipment {
  id                 String             @id @default(uuid()) @db.Uuid
  siteId             String?            @map("site_id") @db.Uuid
  name               String             @db.VarChar(200)
  category           EquipmentCategory  @default(GENERAL)
  serialNumber       String?            @unique @map("serial_number") @db.VarChar(100)
  qrCode             String?            @unique @map("qr_code") @db.VarChar(255)
  status             EquipmentStatus    @default(AVAILABLE)
  condition          EquipmentCondition @default(GOOD)
  manufacturer       String?            @db.VarChar(200)
  model              String?            @db.VarChar(200)
  yearManufactured   Int?               @map("year_manufactured")
  lastServiceDate    DateTime?          @map("last_service_date")
  nextServiceDate    DateTime?          @map("next_service_date")
  serviceHistory     Json?              @default("[]") @map("service_history")
  totalUsageHours    Float              @default(0) @map("total_usage_hours")
  serviceIntervalHours Float?           @map("service_interval_hours")
  purchaseDate       DateTime?          @map("purchase_date")
  purchasePrice      Float?             @map("purchase_price")
  dailyRate          Float?             @map("daily_rate")
  insuranceExpiry    DateTime?          @map("insurance_expiry")
  notes              String?            @db.Text
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  deletedAt          DateTime?          @map("deleted_at")

  // Relations
  site           Site?                  @relation(fields: [siteId], references: [id])
  transferItems  TransferItem[]
  serviceRecords ServiceRecord[]
  siteHistory    EquipmentSiteHistory[]

  @@index([siteId])
  @@index([category])
  @@index([status])
  @@index([qrCode])
  @@index([serialNumber])
  @@index([nextServiceDate])
  @@index([deletedAt])
  @@map("equipment")
}

model ServiceRecord {
  id              String      @id @default(uuid()) @db.Uuid
  equipmentId     String      @map("equipment_id") @db.Uuid
  serviceType     ServiceType @map("service_type")
  serviceDate     DateTime    @map("service_date")
  description     String      @db.Text
  performedBy     String      @map("performed_by") @db.VarChar(200)
  cost            Float?
  partsReplaced   String?     @map("parts_replaced") @db.Text
  nextServiceDate DateTime?   @map("next_service_date")
  meterReading    Float?      @map("meter_reading")
  notes           String?     @db.Text
  createdById     String?     @map("created_by_id") @db.Uuid
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  deletedAt       DateTime?   @map("deleted_at")

  // Relations
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  createdBy User?     @relation("ServiceRecordCreator", fields: [createdById], references: [id])

  @@index([equipmentId])
  @@index([serviceDate])
  @@index([deletedAt])
  @@map("service_records")
}

model EquipmentSiteHistory {
  id          String    @id @default(uuid()) @db.Uuid
  equipmentId String    @map("equipment_id") @db.Uuid
  siteId      String    @map("site_id") @db.Uuid
  assignedAt  DateTime  @default(now()) @map("assigned_at")
  removedAt   DateTime? @map("removed_at")
  transferId  String?   @map("transfer_id") @db.Uuid
  notes       String?   @db.Text

  // Relations
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  site      Site      @relation(fields: [siteId], references: [id])
  transfer  Transfer? @relation(fields: [transferId], references: [id])

  @@index([equipmentId])
  @@index([siteId])
  @@index([transferId])
  @@map("equipment_site_history")
}

model Material {
  id              String    @id @default(uuid()) @db.Uuid
  siteId          String    @map("site_id") @db.Uuid
  name            String    @db.VarChar(200)
  unit            String    @db.VarChar(50)
  currentStock    Float     @default(0) @map("current_stock")
  minimumStock    Float     @default(0) @map("minimum_stock")
  unitPrice       Float?    @default(0) @map("unit_price")
  supplier        String?   @db.VarChar(200)
  stockHistory    Json?     @default("[]") @map("stock_history")
  notes           String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  site          Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)
  transferItems TransferItem[]

  @@index([siteId])
  @@index([name])
  @@index([deletedAt])
  @@map("materials")
}

model Transfer {
  id             String         @id @default(uuid()) @db.Uuid
  fromSiteId     String         @map("from_site_id") @db.Uuid
  toSiteId       String         @map("to_site_id") @db.Uuid
  status         TransferStatus @default(REQUESTED)
  requestedById  String         @map("requested_by_id") @db.Uuid
  approvedById   String?        @map("approved_by_id") @db.Uuid
  approvedAt     DateTime?      @map("approved_at")
  shippedAt      DateTime?      @map("shipped_at")
  deliveredAt    DateTime?      @map("delivered_at")
  cancelledAt    DateTime?      @map("cancelled_at")
  notes          String?        @db.Text
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  deletedAt      DateTime?      @map("deleted_at")

  // Relations
  fromSite     Site           @relation("TransferFromSite", fields: [fromSiteId], references: [id])
  toSite       Site           @relation("TransferToSite", fields: [toSiteId], references: [id])
  requestedBy  User           @relation("TransferRequester", fields: [requestedById], references: [id])
  approvedBy   User?          @relation("TransferApprover", fields: [approvedById], references: [id])
  items        TransferItem[]
  equipmentSiteHistory EquipmentSiteHistory[]

  @@index([fromSiteId])
  @@index([toSiteId])
  @@index([status])
  @@index([requestedById])
  @@index([deletedAt])
  @@map("transfers")
}

model TransferItem {
  id           String  @id @default(uuid()) @db.Uuid
  transferId   String  @map("transfer_id") @db.Uuid
  equipmentId  String? @map("equipment_id") @db.Uuid
  materialId   String? @map("material_id") @db.Uuid
  quantity     Float?
  notes        String? @db.Text

  // Relations
  transfer  Transfer   @relation(fields: [transferId], references: [id], onDelete: Cascade)
  equipment Equipment? @relation(fields: [equipmentId], references: [id])
  material  Material?  @relation(fields: [materialId], references: [id])

  @@index([transferId])
  @@index([equipmentId])
  @@index([materialId])
  @@map("transfer_items")
}

model SyncLog {
  id          String     @id @default(uuid()) @db.Uuid
  userId      String     @map("user_id") @db.Uuid
  clientId    String     @map("client_id") @db.VarChar(100)
  action      SyncAction
  entityType  String     @map("entity_type") @db.VarChar(50)
  entityId    String     @map("entity_id") @db.VarChar(100)
  payload     Json
  appliedAt   DateTime   @default(now()) @map("applied_at")
  serverVersion Int      @default(autoincrement()) @map("server_version")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([clientId])
  @@index([entityType, entityId])
  @@index([appliedAt])
  @@index([serverVersion])
  @@map("sync_logs")
}

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  action     String   @db.VarChar(50)
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String   @map("entity_id") @db.VarChar(100)
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.VarChar(500)
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id        String           @id @default(uuid()) @db.Uuid
  userId    String           @map("user_id") @db.Uuid
  type      NotificationType
  title     String           @db.VarChar(200)
  message   String           @db.Text
  data      Json?
  readAt    DateTime?        @map("read_at")
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([readAt])
  @@index([createdAt])
  @@map("notifications")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model HoldPoint {
  id             String          @id @default(uuid()) @db.Uuid
  activityId     String          @map("activity_id") @db.Uuid
  type           HoldPointType
  status         HoldPointStatus @default(PENDING)
  checklist      Json            @default("[]")
  signedByName   String?         @map("signed_by_name") @db.VarChar(200)
  signedById     String?         @map("signed_by_id") @db.Uuid
  signedAt       DateTime?       @map("signed_at")
  signatureData  String?         @map("signature_data") @db.Text
  rejectionNotes String?         @map("rejection_notes") @db.Text
  comments       String?         @db.Text
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  // Relations
  activity       ActivityRecord  @relation(fields: [activityId], references: [id], onDelete: Cascade)
  signedBy       User?           @relation("HoldPointSigner", fields: [signedById], references: [id])

  @@unique([activityId, type])
  @@index([activityId])
  @@index([status])
  @@map("hold_points")
}

model DailyLog {
  id             String         @id @default(uuid()) @db.Uuid
  siteId         String         @map("site_id") @db.Uuid
  logDate        DateTime       @map("log_date") @db.Date
  status         DailyLogStatus @default(DRAFT)
  workforce      Json           @default("[]")
  safety         Json           @default("{}")
  delays         Json           @default("[]")
  materialUsage  Json           @default("[]")
  weather        Json?
  remarks        String?        @db.Text
  photos         Json?          @default("[]")
  createdById    String         @map("created_by_id") @db.Uuid
  approvedById   String?        @map("approved_by_id") @db.Uuid
  approvedAt     DateTime?      @map("approved_at")
  rejectionNotes String?        @map("rejection_notes") @db.Text
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  deletedAt      DateTime?      @map("deleted_at")

  site       Site  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  createdBy  User  @relation("DailyLogCreator", fields: [createdById], references: [id])
  approvedBy User? @relation("DailyLogApprover", fields: [approvedById], references: [id])

  @@unique([siteId, logDate])
  @@index([siteId])
  @@index([logDate])
  @@index([status])
  @@index([createdById])
  @@index([deletedAt])
  @@map("daily_logs")
}

model BoreholeLog {
  id               String    @id @default(uuid()) @db.Uuid
  siteId           String    @map("site_id") @db.Uuid
  boreholeId       String    @map("borehole_id") @db.VarChar(50)
  logDate          DateTime  @map("log_date") @db.Date
  location         String?   @db.VarChar(200)
  gpsLat           Float?    @map("gps_lat")
  gpsLng           Float?    @map("gps_lng")
  totalDepth       Float     @map("total_depth")
  groundLevel      Float?    @map("ground_level")
  groundwaterLevel Float?    @map("groundwater_level")
  casingDepth      Float?    @map("casing_depth")
  strata           Json      @default("[]")
  sptResults       Json      @default("[]")
  remarks          String?   @db.Text
  photos           Json?     @default("[]")
  drillingMethod   String?   @map("drilling_method") @db.VarChar(100)
  contractor       String?   @db.VarChar(200)
  loggedBy         String?   @map("logged_by") @db.VarChar(200)
  createdById      String    @map("created_by_id") @db.Uuid
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")

  site      Site @relation(fields: [siteId], references: [id], onDelete: Cascade)
  createdBy User @relation("BoreholeLogCreator", fields: [createdById], references: [id])

  @@unique([siteId, boreholeId])
  @@index([siteId])
  @@index([deletedAt])
  @@map("borehole_logs")
}

model TestResult {
  id            String           @id @default(uuid()) @db.Uuid
  siteId        String           @map("site_id") @db.Uuid
  activityId    String?          @map("activity_id") @db.Uuid
  testType      TestType         @map("test_type")
  testDate      DateTime         @map("test_date") @db.Date
  pileId        String?          @map("pile_id") @db.VarChar(50)
  status        TestResultStatus @default(PENDING)
  results       Json             @default("{}")
  remarks       String?          @db.Text
  photos        Json?            @default("[]")
  conductedBy   String?          @map("conducted_by") @db.VarChar(200)
  createdById   String           @map("created_by_id") @db.Uuid
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  deletedAt     DateTime?        @map("deleted_at")

  site       Site            @relation(fields: [siteId], references: [id], onDelete: Cascade)
  activity   ActivityRecord? @relation(fields: [activityId], references: [id])
  createdBy  User            @relation("TestResultCreator", fields: [createdById], references: [id])

  @@index([siteId])
  @@index([activityId])
  @@index([testType])
  @@index([status])
  @@index([deletedAt])
  @@map("test_results")
}
